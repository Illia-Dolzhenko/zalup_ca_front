<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="js/base.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.5.0.js"
            integrity="sha256-r/AaFHrszJtwpe+tHyNi/XCfMxYpbsRg2Uqn0x3s2zc="
            crossorigin="anonymous"></script>


    <title>Post</title>

    <style>
        .post {
            margin-left: auto;
            margin-right: auto;
            margin-top: 2%;
            height: min-content;
            width: min-content;
            display: flex;
            flex-direction: column;
        }

        body {
            background-color: gainsboro;
        }

        img {
            object-fit: scale-down;
            vertical-align: top;
            max-height: 85vh;
            max-width: 90vw;
            margin: 2% 2% -1% 2%;
        }

        .description {
            font-family: "Helvetica", "Arial", sans-serif;
            margin: 2%;
            text-align: center;
            word-wrap: break-word;
            max-width: 75vw;
        }

        .text {
            font-family: "Helvetica", "Arial", sans-serif;
            text-align: left;
            margin-left: 2%;
            margin-right: 2%;
        }

        .left {
            margin-top: 1%;
            display: inline-block;
            font-weight: bold;
        }

        .right {
            float: right;
        }

        .rating {
            font-weight: normal;
            margin-top: 2%;
        }

        .commentBox {
            margin-bottom: 2%;
            width: 75vw;
            min-height: auto;
            max-height: fit-content;
        }

        .userComment {
            margin: 0 2%;
            width: 100vw;
        }

        .commentButton {
            position: initial !important;
            width: 8%;
            margin-bottom: 1%;
            margin-right: 1%;
            float: right;
        }

        .thumb_up {
            margin: 1%;
        }

        .thumb_up_counter {
            margin: 1% 0;
        }


    </style>


</head>
<body>

<div hidden id="post" class="mdl-card mdl-shadow--8dp post">

    <img id="image" src="" alt="image">

    <div class="text">
        <div id="creatorLogin" class="left">username</div>
        <div id="postCreation" class="left right">date</div>
    </div>

    <div id="ratingContainer">
        <div id="rating" class="text">
            <div id="category" class="left rating">Category</div>
            <div id="score" class="left right rating">10.0</div>
        </div>
    </div>


    <div id="description" class="description">
        description
    </div>

</div>

<div hidden id="commentContainer">
    <div id="comment" class="mdl-card mdl-shadow--8dp post commentBox">
        <div class="text">
            <div id="commenterLogin" class="left">username</div>
            <div id="commentCreation" class="left right">date</div>
        </div>
        <div id="commentText" class="description">
            comment text
        </div>
        <div id="thumb_up">
            <i  id="thumb_icon" class="material-icons right thumb_up">thumb_up</i>
            <div id="voteCount" class="left right thumb_up_counter">12</div>
        </div>
    </div>

    <div class="mdl-card mdl-shadow--8dp post commentBox">
        <div class="mdl-textfield mdl-js-textfield">
            <textarea id="newCommentText" class="mdl-textfield__input userComment" type="text" rows="3"></textarea>
            <label class="mdl-textfield__label userComment" for="newCommentText">Your comment...</label>
        </div>

        <div>
            <button id="sendComment" class="mdl-button mdl-js-button mdl-button--raised commentButton">
                Send
            </button>
        </div>
    </div>

</div>

<script>

    $(document).ready(
        sendGet(GET_POST_URL + getId(), renderPost)
    );

    function renderPost(data) {
        console.log(data);
        $("#post").removeAttr("hidden");
        $("#image").attr("src", data.image);
        $("#creatorLogin").html(data.user.login);
        $("#postCreation").html(new Date(data.creationDate).toLocaleString());
        $("#description").html(data.text);

        var commentContainer = $("#commentContainer");
        commentContainer.removeAttr("hidden");
        var newComment = $("#comment").clone();
        $("#comment").remove();

        $.each(data.comments, function (i, comment) {
            var temp = newComment.clone();
            temp.find("#commentText").html(comment.text);
            temp.find("#commenterLogin").html(comment.user.login);
            temp.find("#commentCreation").html(new Date(comment.created).toLocaleString());
            temp.find("#voteCount").html(comment.numberOfUpVotes);
            // if (comment.user.login === localStorage.getItem("login")) {
            //     temp.find("#thumb_icon").attr("hidden", "true");
            // }
            commentContainer.append(temp);
            console.log(comment.id + ": " + comment.text);
        });

        const ratings = data.averageRatings;
        const ratingContainer = $("#ratingContainer");
        var rating = $("#rating").clone();
        $("#rating").remove();

        for (const category in ratings) {
            if (ratings.hasOwnProperty(category)) {
                rating = rating.clone();
                rating.find("#category").html(category);
                rating.find("#score").html(parseFloat(ratings[category]).toPrecision(2));
                ratingContainer.prepend(rating);
                console.log(category + ": " + parseFloat(ratings[category]).toPrecision(2));
            }
        }

    }

    $(document).on("click", "#sendComment", function () {
        console.log("send");
        sendPost(ADD_COMMENT_URL, getData(), function (data) {
            console.log(data);
            $("#newCommentText").val(" ");
            location.reload();
        });
    });

    $(document).on("click", "#thumb_icon", function (e) {
        const commenterLogin = $(e.target).parent().parent().find("#commenterLogin").html();
        if(commenterLogin === localStorage.getItem("login")){
            console.log("You cannot voteUp your comment.");
        }
    });

    function getData() {
        var data = new Object();
        data.text = $("#newCommentText").val();
        data.postId = getId();
        return data;
    }


</script>
</body>
</html>